<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>pytypes.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAPNJREFUeNpi/P//PwMlgOXHUjly9E0G4hwgZmQiQZMqEK8H4v9QzUEgQSaoADK+zhH9iAGL+C0gDoAaNg9mGLoLfgA1awK9hS9gzgJxA9RQBmQDrgMxJzRMGKE4HYj/Ial5A8QmQLwCJoBsgBYW2+TR1ChDaWt4LOBxKsi/VUh8XiD+gq4IVyzwQAMJBoKwacZlAB8Qf0bi96IZhtOAe1D6LpqaEiz6rmEzQAeIzwGxCJpieFqApo/vQKyJboAaEBsAsSEupwI1MwKjGBTVHOhegMX5UajYRqiBjMgYmj400cVh0XgTiKdC0zhJgJHS7AwQYABm9EAdCKrEfAAAAABJRU5ErkJggg=="/>
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-comment">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
</span>
<span class="line" id="L2"><span class="tok-comment">// you may not use this file except in compliance with the License.</span>
</span>
<span class="line" id="L3"><span class="tok-comment">// You may obtain a copy of the License at</span>
</span>
<span class="line" id="L4"><span class="tok-comment">//</span>
</span>
<span class="line" id="L5"><span class="tok-comment">//         http://www.apache.org/licenses/LICENSE-2.0</span>
</span>
<span class="line" id="L6"><span class="tok-comment">//</span>
</span>
<span class="line" id="L7"><span class="tok-comment">// Unless required by applicable law or agreed to in writing, software</span>
</span>
<span class="line" id="L8"><span class="tok-comment">// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
</span>
<span class="line" id="L9"><span class="tok-comment">// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span>
<span class="line" id="L10"><span class="tok-comment">// See the License for the specific language governing permissions and</span>
</span>
<span class="line" id="L11"><span class="tok-comment">// limitations under the License.</span>
</span>
<span class="line" id="L12"></span>
<span class="line" id="L13"><span class="tok-comment">// https://docs.python.org/3/extending/newtypes_tutorial.html</span>
</span>
<span class="line" id="L14"></span>
<span class="line" id="L15"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L16"><span class="tok-kw">const</span> ffi = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ffi.zig&quot;</span>);</span>
<span class="line" id="L17"><span class="tok-kw">const</span> py = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;pydust.zig&quot;</span>);</span>
<span class="line" id="L18"><span class="tok-kw">const</span> funcs = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;functions.zig&quot;</span>);</span>
<span class="line" id="L19"><span class="tok-kw">const</span> PyError = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;errors.zig&quot;</span>).PyError;</span>
<span class="line" id="L20"><span class="tok-kw">const</span> PyMemAllocator = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;mem.zig&quot;</span>).PyMemAllocator;</span>
<span class="line" id="L21"><span class="tok-kw">const</span> tramp = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;trampoline.zig&quot;</span>);</span>
<span class="line" id="L22"><span class="tok-kw">const</span> Type = std.builtin.Type;</span>
<span class="line" id="L23"></span>
<span class="line" id="L24"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ClassDef = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L25">    name: [:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L26">    definition: <span class="tok-type">type</span>,</span>
<span class="line" id="L27">    bases: []<span class="tok-kw">const</span> <span class="tok-type">type</span>,</span>
<span class="line" id="L28">};</span>
<span class="line" id="L29"></span>
<span class="line" id="L30"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">State</span>(<span class="tok-kw">comptime</span> definition: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L31">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L32">        obj: ffi.PyObject,</span>
<span class="line" id="L33">        state: definition,</span>
<span class="line" id="L34">    };</span>
<span class="line" id="L35">}</span>
<span class="line" id="L36"></span>
<span class="line" id="L37"><span class="tok-comment">/// Wrap a user-defined class struct into a unique struct that itself wraps the trampolined functions.</span></span>
<span class="line" id="L38"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">define</span>(<span class="tok-kw">comptime</span> class: ClassDef) <span class="tok-type">type</span> {</span>
<span class="line" id="L39">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L40">        <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L41">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> name: [:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = class.name;</span>
<span class="line" id="L42"></span>
<span class="line" id="L43">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> pyName: [:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = blk: {</span>
<span class="line" id="L44">            <span class="tok-kw">const</span> moduleName = py.findContainingModule(class.definition);</span>
<span class="line" id="L45">            <span class="tok-kw">break</span> :blk moduleName[<span class="tok-number">0</span>..moduleName.len] ++ <span class="tok-str">&quot;.&quot;</span> ++ name;</span>
<span class="line" id="L46">        };</span>
<span class="line" id="L47"></span>
<span class="line" id="L48">        <span class="tok-comment">// Declare a struct representing an instance of the object.</span>
</span>
<span class="line" id="L49">        <span class="tok-kw">const</span> Instance = State(class.definition);</span>
<span class="line" id="L50"></span>
<span class="line" id="L51">        <span class="tok-kw">const</span> slots = Slots(class.definition, Instance);</span>
<span class="line" id="L52"></span>
<span class="line" id="L53">        <span class="tok-kw">const</span> spec = ffi.PyType_Spec{</span>
<span class="line" id="L54">            .name = pyName.ptr,</span>
<span class="line" id="L55">            .basicsize = <span class="tok-builtin">@sizeOf</span>(Instance),</span>
<span class="line" id="L56">            .itemsize = <span class="tok-number">0</span>,</span>
<span class="line" id="L57">            .flags = ffi.Py_TPFLAGS_DEFAULT | ffi.Py_TPFLAGS_BASETYPE,</span>
<span class="line" id="L58">            .slots = <span class="tok-builtin">@constCast</span>(slots.slots.ptr),</span>
<span class="line" id="L59">        };</span>
<span class="line" id="L60"></span>
<span class="line" id="L61">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">init</span>(module: py.PyModule) !py.PyType {</span>
<span class="line" id="L62">            <span class="tok-kw">var</span> basesPtr: ?*ffi.PyObject = <span class="tok-null">null</span>;</span>
<span class="line" id="L63">            <span class="tok-kw">if</span> (class.bases.len &gt; <span class="tok-number">0</span>) {</span>
<span class="line" id="L64">                <span class="tok-kw">const</span> basesTuple = <span class="tok-kw">try</span> py.PyTuple.new(class.bases.len);</span>
<span class="line" id="L65">                <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (class.bases, <span class="tok-number">0</span>..) |base, i| {</span>
<span class="line" id="L66">                    <span class="tok-kw">const</span> baseType = <span class="tok-kw">try</span> module.obj.get(py.getClassName(base));</span>
<span class="line" id="L67">                    <span class="tok-kw">try</span> basesTuple.setItem(i, baseType);</span>
<span class="line" id="L68">                }</span>
<span class="line" id="L69">                basesPtr = basesTuple.obj.py;</span>
<span class="line" id="L70">            }</span>
<span class="line" id="L71"></span>
<span class="line" id="L72">            <span class="tok-kw">var</span> pytype = ffi.PyType_FromModuleAndSpec(module.obj.py, <span class="tok-builtin">@constCast</span>(&amp;spec), basesPtr) <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> PyError.Propagate;</span>
<span class="line" id="L73">            <span class="tok-kw">return</span> .{ .obj = .{ .py = pytype } };</span>
<span class="line" id="L74">        }</span>
<span class="line" id="L75">    };</span>
<span class="line" id="L76">}</span>
<span class="line" id="L77"></span>
<span class="line" id="L78"><span class="tok-kw">fn</span> <span class="tok-fn">Slots</span>(<span class="tok-kw">comptime</span> definition: <span class="tok-type">type</span>, <span class="tok-kw">comptime</span> Instance: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L79">    <span class="tok-kw">const</span> empty = ffi.PyType_Slot{ .slot = <span class="tok-number">0</span>, .pfunc = <span class="tok-null">null</span> };</span>
<span class="line" id="L80"></span>
<span class="line" id="L81">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L82">        <span class="tok-kw">const</span> methods = funcs.Methods(definition);</span>
<span class="line" id="L83"></span>
<span class="line" id="L84">        <span class="tok-comment">/// Slots populated in the PyType</span></span>
<span class="line" id="L85">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> slots: [:empty]<span class="tok-kw">const</span> ffi.PyType_Slot = blk: {</span>
<span class="line" id="L86">            <span class="tok-kw">var</span> slots_: [:empty]<span class="tok-kw">const</span> ffi.PyType_Slot = &amp;.{};</span>
<span class="line" id="L87"></span>
<span class="line" id="L88">            <span class="tok-kw">if</span> (<span class="tok-builtin">@hasDecl</span>(definition, <span class="tok-str">&quot;__doc__&quot;</span>)) {</span>
<span class="line" id="L89">                <span class="tok-kw">const</span> doc: [:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-builtin">@field</span>(definition, <span class="tok-str">&quot;__doc__&quot;</span>);</span>
<span class="line" id="L90">                slots_ = slots_ ++ .{ffi.PyType_Slot{</span>
<span class="line" id="L91">                    .slot = ffi.Py_tp_doc,</span>
<span class="line" id="L92">                    .pfunc = <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@constCast</span>(doc.ptr)),</span>
<span class="line" id="L93">                }};</span>
<span class="line" id="L94">            }</span>
<span class="line" id="L95"></span>
<span class="line" id="L96">            <span class="tok-kw">if</span> (<span class="tok-builtin">@hasDecl</span>(definition, <span class="tok-str">&quot;__new__&quot;</span>)) {</span>
<span class="line" id="L97">                slots_ = slots_ ++ .{ffi.PyType_Slot{</span>
<span class="line" id="L98">                    .slot = ffi.Py_tp_new,</span>
<span class="line" id="L99">                    .pfunc = <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@constCast</span>(&amp;tp_new)),</span>
<span class="line" id="L100">                }};</span>
<span class="line" id="L101">            }</span>
<span class="line" id="L102"></span>
<span class="line" id="L103">            <span class="tok-kw">if</span> (<span class="tok-builtin">@hasDecl</span>(definition, <span class="tok-str">&quot;__del__&quot;</span>)) {</span>
<span class="line" id="L104">                slots_ = slots_ ++ .{ffi.PyType_Slot{</span>
<span class="line" id="L105">                    .slot = ffi.Py_tp_finalize,</span>
<span class="line" id="L106">                    .pfunc = <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@constCast</span>(&amp;tp_finalize)),</span>
<span class="line" id="L107">                }};</span>
<span class="line" id="L108">            }</span>
<span class="line" id="L109"></span>
<span class="line" id="L110">            <span class="tok-kw">if</span> (<span class="tok-builtin">@hasDecl</span>(definition, <span class="tok-str">&quot;__buffer__&quot;</span>)) {</span>
<span class="line" id="L111">                slots_ = slots_ ++ .{ffi.PyType_Slot{</span>
<span class="line" id="L112">                    .slot = ffi.Py_bf_getbuffer,</span>
<span class="line" id="L113">                    .pfunc = <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@constCast</span>(&amp;bf_getbuffer)),</span>
<span class="line" id="L114">                }};</span>
<span class="line" id="L115">            }</span>
<span class="line" id="L116"></span>
<span class="line" id="L117">            <span class="tok-kw">if</span> (<span class="tok-builtin">@hasDecl</span>(definition, <span class="tok-str">&quot;__release_buffer__&quot;</span>)) {</span>
<span class="line" id="L118">                slots_ = slots_ ++ .{ffi.PyType_Slot{</span>
<span class="line" id="L119">                    .slot = ffi.Py_bf_releasebuffer,</span>
<span class="line" id="L120">                    .pfunc = <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@constCast</span>(&amp;bf_releasebuffer)),</span>
<span class="line" id="L121">                }};</span>
<span class="line" id="L122">            }</span>
<span class="line" id="L123"></span>
<span class="line" id="L124">            <span class="tok-kw">if</span> (<span class="tok-builtin">@hasDecl</span>(definition, <span class="tok-str">&quot;__len__&quot;</span>)) {</span>
<span class="line" id="L125">                slots_ = slots_ ++ .{ffi.PyType_Slot{</span>
<span class="line" id="L126">                    .slot = ffi.Py_mp_length,</span>
<span class="line" id="L127">                    .pfunc = <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@constCast</span>(&amp;mp_length)),</span>
<span class="line" id="L128">                }};</span>
<span class="line" id="L129">            }</span>
<span class="line" id="L130"></span>
<span class="line" id="L131">            <span class="tok-kw">if</span> (<span class="tok-builtin">@hasDecl</span>(definition, <span class="tok-str">&quot;__iter__&quot;</span>)) {</span>
<span class="line" id="L132">                slots_ = slots_ ++ .{ffi.PyType_Slot{</span>
<span class="line" id="L133">                    .slot = ffi.Py_tp_iter,</span>
<span class="line" id="L134">                    .pfunc = <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@constCast</span>(&amp;tp_iter)),</span>
<span class="line" id="L135">                }};</span>
<span class="line" id="L136">            }</span>
<span class="line" id="L137"></span>
<span class="line" id="L138">            <span class="tok-kw">if</span> (<span class="tok-builtin">@hasDecl</span>(definition, <span class="tok-str">&quot;__next__&quot;</span>)) {</span>
<span class="line" id="L139">                slots_ = slots_ ++ .{ffi.PyType_Slot{</span>
<span class="line" id="L140">                    .slot = ffi.Py_tp_iternext,</span>
<span class="line" id="L141">                    .pfunc = <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@constCast</span>(&amp;tp_iternext)),</span>
<span class="line" id="L142">                }};</span>
<span class="line" id="L143">            }</span>
<span class="line" id="L144"></span>
<span class="line" id="L145">            slots_ = slots_ ++ .{ffi.PyType_Slot{</span>
<span class="line" id="L146">                .slot = ffi.Py_tp_methods,</span>
<span class="line" id="L147">                .pfunc = <span class="tok-builtin">@ptrCast</span>(<span class="tok-builtin">@constCast</span>(&amp;methods.pydefs)),</span>
<span class="line" id="L148">            }};</span>
<span class="line" id="L149"></span>
<span class="line" id="L150">            slots_ = slots_ ++ .{empty};</span>
<span class="line" id="L151"></span>
<span class="line" id="L152">            <span class="tok-kw">break</span> :blk slots_;</span>
<span class="line" id="L153">        };</span>
<span class="line" id="L154"></span>
<span class="line" id="L155">        <span class="tok-kw">fn</span> <span class="tok-fn">tp_new</span>(subtype: *ffi.PyTypeObject, pyargs: [*c]ffi.PyObject, pykwargs: [*c]ffi.PyObject) <span class="tok-kw">callconv</span>(.C) ?*ffi.PyObject {</span>
<span class="line" id="L156">            <span class="tok-kw">const</span> pyself: *ffi.PyObject = ffi.PyType_GenericAlloc(subtype, <span class="tok-number">0</span>) <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L157">            <span class="tok-comment">// Cast it into a supertype instance. Note: we check at comptime that subclasses of this class</span>
</span>
<span class="line" id="L158">            <span class="tok-comment">// include our own state object as the first field in their struct.</span>
</span>
<span class="line" id="L159">            <span class="tok-kw">const</span> self: *Instance = <span class="tok-builtin">@ptrCast</span>(pyself);</span>
<span class="line" id="L160"></span>
<span class="line" id="L161">            <span class="tok-comment">// Allow the definition to initialize the state field.</span>
</span>
<span class="line" id="L162">            self.state = tp_new_internal(</span>
<span class="line" id="L163">                <span class="tok-kw">if</span> (pyargs) |pa| py.PyTuple.unchecked(.{ .py = pa }) <span class="tok-kw">else</span> <span class="tok-null">null</span>,</span>
<span class="line" id="L164">                <span class="tok-kw">if</span> (pykwargs) |pk| py.PyDict.unchecked(.{ .py = pk }) <span class="tok-kw">else</span> <span class="tok-null">null</span>,</span>
<span class="line" id="L165">            ) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L166"></span>
<span class="line" id="L167">            <span class="tok-kw">return</span> pyself;</span>
<span class="line" id="L168">        }</span>
<span class="line" id="L169"></span>
<span class="line" id="L170">        <span class="tok-kw">fn</span> <span class="tok-fn">tp_new_internal</span>(pyargs: ?py.PyTuple, pykwargs: ?py.PyDict) !definition {</span>
<span class="line" id="L171">            <span class="tok-kw">const</span> sig = funcs.parseSignature(<span class="tok-str">&quot;__new__&quot;</span>, <span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@TypeOf</span>(definition.__new__)).Fn, &amp;.{});</span>
<span class="line" id="L172">            <span class="tok-kw">if</span> (sig.selfParam) |_| <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;__new__ must not take a self parameter&quot;</span>);</span>
<span class="line" id="L173"></span>
<span class="line" id="L174">            <span class="tok-kw">const</span> Args = sig.argsParam <span class="tok-kw">orelse</span> <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;__new__ must take an args struct&quot;</span>);</span>
<span class="line" id="L175">            <span class="tok-kw">const</span> args = <span class="tok-kw">try</span> tramp.Trampoline(Args).unwrapCallArgs(.{ .args = pyargs, .kwargs = pykwargs });</span>
<span class="line" id="L176"></span>
<span class="line" id="L177">            <span class="tok-kw">return</span> <span class="tok-kw">try</span> definition.__new__(args);</span>
<span class="line" id="L178">        }</span>
<span class="line" id="L179"></span>
<span class="line" id="L180">        <span class="tok-comment">/// Wrapper for the user's __del__ function.</span></span>
<span class="line" id="L181">        <span class="tok-comment">/// Note: tp_del is deprecated in favour of tp_finalize.</span></span>
<span class="line" id="L182">        <span class="tok-comment">///</span></span>
<span class="line" id="L183">        <span class="tok-comment">/// See https://docs.python.org/3/c-api/typeobj.html#c.PyTypeObject.tp_finalize.</span></span>
<span class="line" id="L184">        <span class="tok-kw">fn</span> <span class="tok-fn">tp_finalize</span>(pyself: *ffi.PyObject) <span class="tok-type">void</span> {</span>
<span class="line" id="L185">            <span class="tok-comment">// The finalize slot shouldn't alter any exception that is currently set.</span>
</span>
<span class="line" id="L186">            <span class="tok-comment">// So it's recommended we save the existing one (if any) and restore it afterwards.</span>
</span>
<span class="line" id="L187">            <span class="tok-comment">// NOTE(ngates): we may want to move this logic to PyErr if it happens more?</span>
</span>
<span class="line" id="L188">            <span class="tok-kw">var</span> error_type: ?*ffi.PyObject = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L189">            <span class="tok-kw">var</span> error_value: ?*ffi.PyObject = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L190">            <span class="tok-kw">var</span> error_tb: ?*ffi.PyObject = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L191">            ffi.PyErr_Fetch(&amp;error_type, &amp;error_value, &amp;error_tb);</span>
<span class="line" id="L192"></span>
<span class="line" id="L193">            <span class="tok-kw">const</span> instance: *Instance = <span class="tok-builtin">@ptrCast</span>(pyself);</span>
<span class="line" id="L194">            definition.__del__(&amp;instance.state);</span>
<span class="line" id="L195"></span>
<span class="line" id="L196">            ffi.PyErr_Restore(error_type, error_value, error_tb);</span>
<span class="line" id="L197">        }</span>
<span class="line" id="L198"></span>
<span class="line" id="L199">        <span class="tok-kw">fn</span> <span class="tok-fn">bf_getbuffer</span>(pyself: *ffi.PyObject, view: *ffi.Py_buffer, flags: <span class="tok-type">c_int</span>) <span class="tok-kw">callconv</span>(.C) <span class="tok-type">c_int</span> {</span>
<span class="line" id="L200">            <span class="tok-comment">// In case of any error, the view.obj field must be set to NULL.</span>
</span>
<span class="line" id="L201">            view.obj = <span class="tok-null">null</span>;</span>
<span class="line" id="L202"></span>
<span class="line" id="L203">            <span class="tok-kw">const</span> self: *Instance = <span class="tok-builtin">@ptrCast</span>(pyself);</span>
<span class="line" id="L204">            definition.__buffer__(&amp;self.state, <span class="tok-builtin">@ptrCast</span>(view), flags) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> -<span class="tok-number">1</span>;</span>
<span class="line" id="L205">            <span class="tok-kw">return</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L206">        }</span>
<span class="line" id="L207"></span>
<span class="line" id="L208">        <span class="tok-kw">fn</span> <span class="tok-fn">bf_releasebuffer</span>(pyself: *ffi.PyObject, view: *ffi.Py_buffer) <span class="tok-kw">callconv</span>(.C) <span class="tok-type">void</span> {</span>
<span class="line" id="L209">            <span class="tok-kw">const</span> self: *Instance = <span class="tok-builtin">@ptrCast</span>(pyself);</span>
<span class="line" id="L210">            <span class="tok-kw">return</span> definition.__release_buffer__(&amp;self.state, <span class="tok-builtin">@ptrCast</span>(view));</span>
<span class="line" id="L211">        }</span>
<span class="line" id="L212"></span>
<span class="line" id="L213">        <span class="tok-kw">fn</span> <span class="tok-fn">mp_length</span>(pyself: *ffi.PyObject) <span class="tok-kw">callconv</span>(.C) <span class="tok-type">isize</span> {</span>
<span class="line" id="L214">            <span class="tok-kw">const</span> self: *<span class="tok-kw">const</span> Instance = <span class="tok-builtin">@ptrCast</span>(pyself);</span>
<span class="line" id="L215">            <span class="tok-kw">const</span> result = definition.__len__(&amp;self.state) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> -<span class="tok-number">1</span>;</span>
<span class="line" id="L216">            <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(<span class="tok-type">isize</span>, <span class="tok-builtin">@intCast</span>(result));</span>
<span class="line" id="L217">        }</span>
<span class="line" id="L218"></span>
<span class="line" id="L219">        <span class="tok-kw">fn</span> <span class="tok-fn">tp_iter</span>(pyself: *ffi.PyObject) <span class="tok-kw">callconv</span>(.C) ?*ffi.PyObject {</span>
<span class="line" id="L220">            <span class="tok-kw">const</span> self: *Instance = <span class="tok-builtin">@ptrCast</span>(pyself);</span>
<span class="line" id="L221">            <span class="tok-kw">const</span> iterator = definition.__iter__(&amp;self.state) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L222">            <span class="tok-kw">return</span> (py.createOwned(iterator) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-null">null</span>).py;</span>
<span class="line" id="L223">        }</span>
<span class="line" id="L224"></span>
<span class="line" id="L225">        <span class="tok-kw">fn</span> <span class="tok-fn">tp_iternext</span>(pyself: *ffi.PyObject) <span class="tok-kw">callconv</span>(.C) ?*ffi.PyObject {</span>
<span class="line" id="L226">            <span class="tok-kw">const</span> self: *Instance = <span class="tok-builtin">@ptrCast</span>(pyself);</span>
<span class="line" id="L227">            <span class="tok-kw">const</span> optionalNext = definition.__next__(&amp;self.state) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L228">            <span class="tok-kw">if</span> (optionalNext) |next| {</span>
<span class="line" id="L229">                <span class="tok-kw">return</span> (py.createOwned(next) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-null">null</span>).py;</span>
<span class="line" id="L230">            }</span>
<span class="line" id="L231">            <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L232">        }</span>
<span class="line" id="L233">    };</span>
<span class="line" id="L234">}</span>
<span class="line" id="L235"></span>
</code></pre></body>
</html>